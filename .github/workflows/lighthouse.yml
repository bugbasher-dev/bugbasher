name: üî¶ Lighthouse Performance

on:
  pull_request:
    paths:
      - 'apps/web/**'
      - 'packages/ui/**'
      - 'packages/config/**'

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  deployments: write

env:
  CLOUDFLARE_PROJECT_NAME: epic-startup-web

jobs:
  preview-deploy:
    name: üöÄ Preview Deploy
    runs-on: ubuntu-24.04
    outputs:
      preview_url: ${{ steps.deploy.outputs.url }}
      deployment_id: ${{ steps.deploy.outputs.id }}
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: ‚éî Setup node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22

      - name: üì• Download deps
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1

      - name: üì• Install platform deps
        run: npm install @rollup/rollup-linux-x64-gnu lightningcss-linux-x64-gnu @tailwindcss/oxide-linux-x64-gnu --save-optional

      - name: üèó Build Web App
        run: |
          cd apps/web
          npm run build
        env:
          PUBLIC_CMS_URL: ${{ secrets.PUBLIC_CMS_URL }}

      - name: üöÄ Deploy Preview to Cloudflare Pages
        id: deploy
        uses: cloudflare/pages-action@f0a1cd58cd66095dee69bfa18fa5efd1dde93bca # v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ env.CLOUDFLARE_PROJECT_NAME }}
          directory: apps/web/dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.head_ref }}

      - name: üìù Comment Preview URL
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const previewUrl = '${{ steps.deploy.outputs.url }}';
            const body = `## üöÄ Preview Deployment

            | Environment | URL |
            |-------------|-----|
            | Preview | [${previewUrl}](${previewUrl}) |

            _Lighthouse performance audit will run automatically._`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  lighthouse:
    name: üî¶ Lighthouse Audit
    runs-on: ubuntu-24.04
    needs: preview-deploy
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: ‚éî Setup node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22

      - name: üì• Install Lighthouse CI
        run: npm install -g @lhci/cli@0.14.x

      - name: ‚è≥ Wait for deployment to be ready
        run: |
          echo "Waiting for preview deployment to be ready..."
          sleep 30
          
          # Verify the URL is accessible
          max_attempts=10
          attempt=1
          url="${{ needs.preview-deploy.outputs.preview_url }}"
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt: Checking $url"
            status=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
            
            if [ "$status" = "200" ]; then
              echo "‚úÖ Preview deployment is ready!"
              break
            fi
            
            echo "Status: $status - Waiting 10 seconds..."
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "‚ùå Preview deployment not ready after $max_attempts attempts"
            exit 1
          fi

      - name: üî¶ Run Lighthouse CI
        id: lighthouse
        run: |
          lhci autorun \
            --config=apps/web/lighthouserc.js \
            --collect.url="${{ needs.preview-deploy.outputs.preview_url }}" \
            --collect.url="${{ needs.preview-deploy.outputs.preview_url }}/about" \
            --collect.url="${{ needs.preview-deploy.outputs.preview_url }}/blog"
        env:
          # Optional: Install https://github.com/apps/lighthouse-ci for enhanced GitHub integration
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN || '' }}

      - name: üìä Upload Lighthouse Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 14

      - name: üìù Comment Lighthouse Results
        if: always()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read lighthouse results
            const lhciDir = '.lighthouseci';
            let results = [];
            
            try {
              const files = fs.readdirSync(lhciDir);
              const jsonFiles = files.filter(f => f.endsWith('.json') && f.startsWith('lhr-'));
              
              for (const file of jsonFiles) {
                const content = fs.readFileSync(path.join(lhciDir, file), 'utf8');
                const lhr = JSON.parse(content);
                results.push({
                  url: lhr.finalUrl || lhr.requestedUrl,
                  performance: Math.round(lhr.categories.performance.score * 100),
                  accessibility: Math.round(lhr.categories.accessibility.score * 100),
                  bestPractices: Math.round(lhr.categories['best-practices'].score * 100),
                  seo: Math.round(lhr.categories.seo.score * 100),
                });
              }
            } catch (e) {
              console.log('Could not read lighthouse results:', e.message);
            }
            
            // Calculate averages
            const avg = (arr, key) => Math.round(arr.reduce((sum, r) => sum + r[key], 0) / arr.length);
            
            const getScoreEmoji = (score) => {
              if (score >= 98) return 'üü¢';
              if (score >= 90) return 'üü°';
              return 'üî¥';
            };
            
            const getStatus = (score) => {
              if (score >= 98) return 'PASS ‚úÖ';
              return 'FAIL ‚ùå';
            };
            
            let body = `## üî¶ Lighthouse Performance Report

            | Metric | Score | Status |
            |--------|-------|--------|`;
            
            if (results.length > 0) {
              const perfAvg = avg(results, 'performance');
              const a11yAvg = avg(results, 'accessibility');
              const bpAvg = avg(results, 'bestPractices');
              const seoAvg = avg(results, 'seo');
              
              body += `
            | ${getScoreEmoji(perfAvg)} Performance | **${perfAvg}** | ${getStatus(perfAvg)} |
            | ${getScoreEmoji(a11yAvg)} Accessibility | **${a11yAvg}** | ${getStatus(a11yAvg)} |
            | ${getScoreEmoji(bpAvg)} Best Practices | **${bpAvg}** | ${getStatus(bpAvg)} |
            | ${getScoreEmoji(seoAvg)} SEO | **${seoAvg}** | ${getStatus(seoAvg)} |

            ### üìã Detailed Results

            | Page | Performance | Accessibility | Best Practices | SEO |
            |------|-------------|---------------|----------------|-----|`;
              
              for (const r of results) {
                const pagePath = new URL(r.url).pathname || '/';
                body += `
            | \`${pagePath}\` | ${getScoreEmoji(r.performance)} ${r.performance} | ${getScoreEmoji(r.accessibility)} ${r.accessibility} | ${getScoreEmoji(r.bestPractices)} ${r.bestPractices} | ${getScoreEmoji(r.seo)} ${r.seo} |`;
              }
              
              body += `

            ---
            üéØ **Target:** All scores must be ‚â• 98
            üìä **Runs:** 3 per page (median reported)
            üîó **Preview:** ${{ needs.preview-deploy.outputs.preview_url }}`;
              
              // Check if any score is below threshold
              const allPassing = perfAvg >= 98 && a11yAvg >= 98 && bpAvg >= 98 && seoAvg >= 98;
              
              if (!allPassing) {
                body += `

            ‚ö†Ô∏è **Performance budget exceeded!** Please optimize before merging.`;
              }
            } else {
              body += `

            ‚ùå Could not retrieve Lighthouse results. Check the workflow logs.`;
            }
            
            // Find and update existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Lighthouse Performance Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  performance-gate:
    name: üö¶ Performance Gate
    runs-on: ubuntu-24.04
    needs: [preview-deploy, lighthouse]
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: üì• Download Lighthouse Report
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: lighthouse-report
          path: .lighthouseci/

      - name: üö¶ Check Performance Budget
        run: |
          echo "Checking performance scores against budget..."
          
          # Find all lighthouse result files
          for file in .lighthouseci/lhr-*.json; do
            if [ -f "$file" ]; then
              echo "Checking: $file"
              
              # Extract scores using node
              node -e "
                const lhr = require('./$file');
                const url = lhr.finalUrl || lhr.requestedUrl;
                const perf = Math.round(lhr.categories.performance.score * 100);
                const a11y = Math.round(lhr.categories.accessibility.score * 100);
                const bp = Math.round(lhr.categories['best-practices'].score * 100);
                const seo = Math.round(lhr.categories.seo.score * 100);
                
                console.log('URL:', url);
                console.log('Performance:', perf);
                console.log('Accessibility:', a11y);
                console.log('Best Practices:', bp);
                console.log('SEO:', seo);
                
                const threshold = 98;
                let failed = false;
                
                if (perf < threshold) {
                  console.error('‚ùå Performance score ' + perf + ' is below threshold ' + threshold);
                  failed = true;
                }
                if (a11y < threshold) {
                  console.error('‚ùå Accessibility score ' + a11y + ' is below threshold ' + threshold);
                  failed = true;
                }
                if (bp < threshold) {
                  console.error('‚ùå Best Practices score ' + bp + ' is below threshold ' + threshold);
                  failed = true;
                }
                if (seo < threshold) {
                  console.error('‚ùå SEO score ' + seo + ' is below threshold ' + threshold);
                  failed = true;
                }
                
                if (failed) {
                  process.exit(1);
                }
                
                console.log('‚úÖ All scores pass threshold of', threshold);
              "
            fi
          done
          
          echo "‚úÖ All pages pass performance budget!"
