---
import GridDesign from '../GridDesign.astro'

interface Props {
	richText?: any
	title?: string
	subtitle?: string
	columns?: Array<{
		richText?: any
		size?: 'oneThird' | 'half' | 'twoThirds' | 'full'
		enableLink?: boolean
		link?: any
	}>
	blockType: 'content'
}

const { richText, title, subtitle, columns } = Astro.props

// Enhanced content renderer for Lexical content
const renderLexicalContent = (content: any) => {
	if (!content || !content.root || !content.root.children) {
		return ''
	}

	return content.root.children
		.map((node: any) => {
			if (node.type === 'paragraph' && node.children) {
				const text = node.children
					.map((child: any) => {
						if (child.format && child.format > 0) {
							// Handle bold, italic, etc.
							let formattedText = child.text || ''
							if (child.format & 1)
								formattedText = `<strong class="font-semibold text-card-foreground">${formattedText}</strong>` // Bold
							if (child.format & 2) formattedText = `<em class="italic">${formattedText}</em>` // Italic
							return formattedText
						}
						return child.text || ''
					})
					.join('')
				return `<p class="text-base text-muted-foreground leading-relaxed mb-4">${text}</p>`
			}
			if (node.type === 'heading' && node.children) {
				const text = node.children
					.map((child: any) => child.text || '')
					.join('')
				const tag = node.tag || 'h2'
				const headingClasses = {
					h1: 'text-3xl md:text-5xl font-title text-card-foreground mb-6',
					h2: 'text-2xl md:text-4xl font-title text-card-foreground mb-5',
					h3: 'text-xl md:text-3xl font-medium text-card-foreground mb-4',
					h4: 'text-lg md:text-2xl font-medium text-card-foreground mb-4',
					h5: 'text-base md:text-xl font-semibold text-card-foreground mb-3',
					h6: 'text-sm md:text-lg font-semibold text-card-foreground mb-3',
				}
				const className =
					headingClasses[tag as keyof typeof headingClasses] ||
					headingClasses.h2
				return `<${tag} class="${className}">${text}</${tag}>`
			}
			if (node.type === 'list' && node.children) {
				const listItems = node.children
					.map((item: any) => {
						if (item.type === 'listitem' && item.children) {
							const itemText = item.children
								.map((child: any) => {
									if (child.type === 'paragraph' && child.children) {
										return child.children
											.map((textChild: any) => textChild.text || '')
											.join('')
									}
									return child.text || ''
								})
								.join('')
							return `<li class="text-base text-muted-foreground leading-relaxed mb-2 pl-2">${itemText}</li>`
						}
						return ''
					})
					.join('')

				if (node.listType === 'number') {
					return `<ol class="list-decimal list-inside mb-6 space-y-2 pl-6">${listItems}</ol>`
				} else {
					return `<ul class="list-disc list-inside mb-6 space-y-2 pl-6">${listItems}</ul>`
				}
			}
			if (node.type === 'quote' && node.children) {
				const text = node.children
					.map((child: any) => {
						if (child.type === 'paragraph' && child.children) {
							return child.children
								.map((textChild: any) => textChild.text || '')
								.join('')
						}
						return child.text || ''
					})
					.join('')
				return `<blockquote class="border-l-2 border-primary/50 bg-muted/30 p-5 my-6 text-base italic text-muted-foreground rounded-r-lg">"${text}"</blockquote>`
			}
			return ''
		})
		.join('')
}
---

{richText && (
	<!-- New design with richText field -->
	<section class="w-full py-16 md:py-24 relative" aria-labelledby={subtitle ? "content-section-title" : undefined}>
		<GridDesign />
		<div class="container relative mx-auto px-4 md:px-6">
			{
				(title || subtitle) && (
					<header class="text-center mb-12">
						{title && (
							<p class="font-mono text-xs uppercase tracking-wide text-muted-foreground mb-4">
								// {title}
							</p>
						)}
						{subtitle && (
							<h2 id="content-section-title" class="text-4xl md:text-6xl font-title text-foreground mb-4">
								{subtitle}
							</h2>
						)}
					</header>
				)
			}

			<div class="max-w-4xl mx-auto">
				<div class="bg-muted dark:bg-background rounded-2xl p-1">
					<div class="bg-card ring-border rounded-2lg p-8 md:p-12 shadow-sm ring-1">
						<div set:html={renderLexicalContent(richText)} />
					</div>
				</div>
			</div>
		</div>
	</section>
)} 

{columns && columns.length > 0 && (
	<!-- Legacy column-based design -->
	<section class="py-16 relative">
    <GridDesign />
		<div class="container mx-auto px-4 md:px-6">
			<div class="grid grid-cols-4 lg:grid-cols-12 gap-y-8">
				{columns.map((col, index) => {
					const colsSpanClasses = {
						full: 'col-span-4 lg:col-span-12',
						half: 'col-span-4 lg:col-span-6 md:col-span-2',
						oneThird: 'col-span-4 lg:col-span-4 md:col-span-2',
						twoThirds: 'col-span-4 lg:col-span-8 md:col-span-2',
					}
					const colClass = colsSpanClasses[col.size || 'full']
					
					return (
						<div class={colClass}>
							{col.richText && (
								<div set:html={renderLexicalContent(col.richText)} />
							)}
							{col.enableLink && col.link && (
								<a href={col.link.url} class="inline-flex items-center text-primary hover:text-primary/80 transition-colors">
									{col.link.label}
								</a>
							)}
						</div>
					)
				})}
			</div>
		</div>
	</section>
)}
