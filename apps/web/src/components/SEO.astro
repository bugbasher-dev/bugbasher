---
interface Props {
  title?: string
  description?: string
  image?: string | { url: string; alt?: string; width?: number; height?: number }
  type?: 'website' | 'article'
  publishedTime?: string
  modifiedTime?: string
  author?: string
  keywords?: string[]
  noindex?: boolean
  nofollow?: boolean
  breadcrumbs?: Array<{ name: string; url: string }>
  faq?: Array<{ question: string; answer: string }>
  readingTime?: number
  wordCount?: number
}

import { brand } from '@repo/config/brand'

const {
  title = `${brand.name} - ${brand.tagline}`,
  description = brand.description,
  image,
  type = 'website',
  publishedTime,
  modifiedTime,
  author,
  keywords = [],
  noindex = false,
  nofollow = false,
  breadcrumbs = [],
  faq = [],
  readingTime,
  wordCount,
} = Astro.props

const imageUrl = typeof image === 'object' && image?.url ? image.url : typeof image === 'string' ? image : undefined
const imageAlt = typeof image === 'object' && image?.alt ? image.alt : title
const imageWidth = typeof image === 'object' && image?.width ? image.width : 1200
const imageHeight = typeof image === 'object' && image?.height ? image.height : 630

const canonicalURL = new URL(Astro.url.pathname, Astro.site)
const siteUrl = Astro.site?.toString().replace(/\/$/, '') || ''

// Build robots meta content
const robotsContent = [
  noindex ? 'noindex' : 'index',
  nofollow ? 'nofollow' : 'follow',
  'max-image-preview:large',
  'max-snippet:-1',
  'max-video-preview:-1',
].join(', ')

// Organization schema (always included for brand recognition)
const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: brand.name,
  url: siteUrl,
  logo: `${siteUrl}/favicons/android-chrome-512x512.png`,
  sameAs: [
    `https://twitter.com/${brand.twitterHandle?.replace('@', '')}`,
  ],
  contactPoint: {
    '@type': 'ContactPoint',
    email: brand.supportEmail,
    contactType: 'customer support',
  },
}

// WebSite schema with search action
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: brand.name,
  description: brand.description,
  url: siteUrl,
  potentialAction: {
    '@type': 'SearchAction',
    target: {
      '@type': 'EntryPoint',
      urlTemplate: `${siteUrl}/blog?q={search_term_string}`,
    },
    'query-input': 'required name=search_term_string',
  },
}

// Article schema (for blog posts)
const articleSchema = type === 'article' ? {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description: description,
  image: imageUrl ? [imageUrl] : undefined,
  datePublished: publishedTime,
  dateModified: modifiedTime || publishedTime,
  author: {
    '@type': 'Organization',
    name: author || brand.name,
    url: siteUrl,
  },
  publisher: {
    '@type': 'Organization',
    name: brand.name,
    logo: {
      '@type': 'ImageObject',
      url: `${siteUrl}/favicons/android-chrome-512x512.png`,
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalURL.toString(),
  },
  ...(wordCount && { wordCount }),
  ...(readingTime && { timeRequired: `PT${readingTime}M` }),
} : null

// Breadcrumb schema
const breadcrumbSchema = breadcrumbs.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: breadcrumbs.map((crumb, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    name: crumb.name,
    item: crumb.url.startsWith('http') ? crumb.url : `${siteUrl}${crumb.url}`,
  })),
} : null

// FAQ schema
const faqSchema = faq.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faq.map((item) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer,
    },
  })),
} : null
---

<title>{title}</title>
<meta name="description" content={description} />
<link rel="canonical" href={canonicalURL} />

<!-- Additional SEO Meta Tags -->
<meta name="robots" content={robotsContent} />
<meta name="googlebot" content={robotsContent} />
<meta name="bingbot" content={robotsContent} />
{author && <meta name="author" content={author} />}
{keywords.length > 0 && <meta name="keywords" content={keywords.join(', ')} />}
<meta name="theme-color" content="#1f2028" media="(prefers-color-scheme: dark)" />
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
<meta name="color-scheme" content="dark light" />
<meta name="format-detection" content="telephone=no" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content={brand.shortName} />

<!-- Alternate language versions (for future i18n) -->
<link rel="alternate" hreflang="en" href={canonicalURL} />
<link rel="alternate" hreflang="x-default" href={canonicalURL} />

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title={`${brand.name} Blog RSS Feed`} href={`${siteUrl}/rss.xml`} />

<!-- Open Graph -->
<meta property="og:type" content={type} />
<meta property="og:url" content={canonicalURL} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:site_name" content={brand.name} />
<meta property="og:locale" content="en_US" />
{imageUrl && <meta property="og:image" content={imageUrl} />}
{imageUrl && <meta property="og:image:secure_url" content={imageUrl} />}
{imageAlt && <meta property="og:image:alt" content={imageAlt} />}
{imageUrl && <meta property="og:image:width" content={imageWidth.toString()} />}
{imageUrl && <meta property="og:image:height" content={imageHeight.toString()} />}
{imageUrl && <meta property="og:image:type" content="image/png" />}
{publishedTime && <meta property="article:published_time" content={publishedTime} />}
{modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
{author && <meta property="article:author" content={author} />}
{keywords.length > 0 && <meta property="article:tag" content={keywords[0]} />}

<!-- Twitter -->
<meta name="twitter:card" content={imageUrl ? 'summary_large_image' : 'summary'} />
<meta name="twitter:url" content={canonicalURL} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
{imageUrl && <meta name="twitter:image" content={imageUrl} />}
{imageAlt && <meta name="twitter:image:alt" content={imageAlt} />}
<meta name="twitter:site" content={brand.twitterHandle} />
<meta name="twitter:creator" content={brand.twitterHandle} />
<meta name="twitter:domain" content={siteUrl.replace(/^https?:\/\//, '')} />

<!-- Structured Data (JSON-LD) -->
<script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
<script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
{articleSchema && <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />}
{breadcrumbSchema && <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />}
{faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}
